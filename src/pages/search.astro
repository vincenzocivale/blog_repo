---
import "@pagefind/default-ui/css/ui.css";
import Main from "@/layouts/Main.astro";
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import { SITE } from "@/config";

const base = import.meta.env.BASE_URL;
---

<Layout title={`Search | ${SITE.title}`}>
  <Header />
  <Main pageTitle="Search" pageDesc="Search any article ...">
    <div id="search" transition:persist></div>
  </Main>
  <Footer />
</Layout>

<script define:vars={{ base }}>
  // This needs to be a standard script that runs on each page load,
  // especially with view transitions.
  const initPagefind = () => {
    // Check if the search UI has already been initialized.
    // If so, do nothing. This can happen with view transitions.
    if (document.querySelector("#search .pagefind-ui__form")) {
      return;
    }

    // @ts-ignore
    if (typeof PagefindUI !== "undefined") {
      // @ts-ignore
      new PagefindUI({
        element: "#search",
        showSubResults: true,
        showImages: false,
      });
    } else {
      // If PagefindUI is not available, wait for the script to load.
      // This is a fallback for initial page load.
      document
        .querySelector(`script[src*="pagefind.js"]`)
        ?.addEventListener("load", () => {
          // @ts-ignore
          new PagefindUI({
            element: "#search",
            showSubResults: true,
            showImages: false,
          });
        });
    }
  };

  // Run on initial page load
  initPagefind();

  // Run after view transitions
  document.addEventListener("astro:after-swap", initPagefind);
</script>

<!-- This script is what loads the Pagefind UI logic -->
<script is:inline define:vars={{ base }}>
  const script = document.createElement("script");
  // Construct the correct path using the base URL
  script.src = `${base.replace(/\/$/, "")}/pagefind/pagefind.js`;
  script.async = true;
  script.onload = () => {
    // Once the script is loaded, PagefindUI will be on the window object.
    // We can dispatch a custom event to let our other script know it's ready.
    document.dispatchEvent(new Event("pagefind:load"));
  };
  document.body.appendChild(script);
</script>

<style is:global>
  #search {
    --pagefind-ui-font: var(--font-mono);
    --pagefind-ui-text: var(--foreground);
    --pagefind-ui-background: var(--background);
    --pagefind-ui-border: var(--border);
    --pagefind-ui-primary: var(--accent);
    --pagefind-ui-tag: var(--background);
    --pagefind-ui-border-radius: 0.375rem;
    --pagefind-ui-border-width: 1px;
    --pagefind-ui-image-border-radius: 8px;
    --pagefind-ui-image-box-ratio: 3 / 2;

    form::before {
      background-color: var(--foreground);
    }

    input {
      font-weight: 400;
      border: 1px solid var(--border);
    }

    input:focus-visible {
      outline: 1px solid var(--accent);
    }

    .pagefind-ui__result-title a {
      color: var(--accent);
      outline-offset: 1px;
      outline-color: var(--accent);
    }

    .pagefind-ui__result-title a:focus-visible,
    .pagefind-ui__search-clear:focus-visible {
      text-decoration-line: none;
      outline-width: 2px;
      outline-style: dashed;
    }

    .pagefind-ui__result:last-of-type {
      border-bottom: 0;
    }

    .pagefind-ui__result-nested .pagefind-ui__result-link:before {
      font-family: system-ui;
    }
  }
</style>
